# Payment Integration TODO (Portone + Eximbay)

## 개요

- 결제는 Portone MCP Server를 통해 엑심베이(PG)로 처리합니다.
- 예약 생성 후 20분 내 결제 완료가 필수이며 만료 시 예약은 취소됩니다.

## 선행 조건(Prerequisites)

- 환경변수 설정: `NEXT_PUBLIC_BASE_URL` (하드코딩 금지)
- API 유틸 사용: `src/lib/api.ts`의 `apiGet`, `apiPost`, `apiPostWithResponse`
- 인증: 모든 요청 `credentials: 'include'`
- i18n: 메시지는 `src/messages/*`에서 관리, 컴포넌트 내 직접 정의 금지

## 작업 항목

1. 결제 초기화 및 PG 연동 (JDK 방식 - 엑심베이 결제창에서 수단 선택)

- [ ] 결제 버튼 핸들러 추가 (단일 "결제하기" 버튼)
- [ ] 결제 파라미터 구성: 금액, 주문명, 통화, 예약ID, 사용자 정보
- [ ] 중복 클릭 방지 및 로딩 상태 처리
- [ ] 타이머 만료 시 결제 버튼 비활성화

2. 서버 결제 요청 API 연동 (JDK 방식)

- [ ] 서버 결제 요청 API 호출 (POST /api/payment/create 또는 유사)
- [ ] 결제창 URL/파라미터 수신 및 검증
- [ ] 엑심베이 결제창 팝업 또는 리다이렉트 처리
- [ ] 결제창 타이틀/크기 설정

3. 엑심베이 리다이렉트/콜백 처리

- [ ] 성공/실패/취소 콜백 라우트 설계 (Next.js page 또는 Route Handler)
- [ ] 콜백 검증(상태/서명/중복처리) 및 사용자 메시지 노출
- [ ] 실패/취소 시 재시도/홈 이동 UX 제공

4. 예약 확인 API 연동 (결제 성공 시)

- [ ] `POST /api/user/reserve/confirm/{reservationId}` 호출로 상태 `RESERVATION_PENDING` 반영
- [ ] 성공 후 `/bookings/{reservationId}`로 이동
- [ ] 실패 시 롤백/재시도 안내

5. 20분 타임아웃 일원화

- [ ] 타이머 만료 시 결제 버튼 비활성화, 안내 배너 노출
- [ ] 만료 즉시 홈 또는 리스트로 안전 리다이렉트
- [ ] 서버 응답의 `endToReserve` 기반 재검증 유지

6. 상태 폴링/재검증

- [ ] 결제 완료 후 단건 조회로 최종 상태 확인 (`GET /api/user/reserve/{id}`)
- [ ] 필요 시 짧은 폴링(최대 N회) 후 타임아웃 처리

7. 에러/예외 처리 및 i18n

- [ ] 40101/40102/403 공통 처리 준수 (자동 갱신/로그아웃/접근거부)
- [ ] Portone/Eximbay 에러코드 → 사용자 메시지 매핑 추가(ko/en/zh/fr)
- [ ] 네트워크 오류/사용자 취소/중복결제 방지 처리

8. 보안/환경 점검

- [ ] 민감정보 하드코딩 금지, env만 사용
- [ ] SameSite/HttpOnly 쿠키 정책 준수(이미 구현 확인)
- [ ] 결제 금액/통화/예약ID 서버 소스오브트루스 기반 검증

9. UI/UX 마감

- [ ] 진행 로딩/스켈레톤/토스트(성공/실패) 추가
- [ ] 접근성 레이블/포커스 트랩(모달 사용 시)
- [ ] 모바일 반응형 및 버튼 탭 영역 강화

10. 문서/테스트

- [ ] ARCHITECTURE의 11장에 실제 엔드포인트/흐름 반영 최신화(완료 여부 체크)
- [ ] 수동 테스트 체크리스트 작성(성공/실패/취소/만료/401/403)
- [ ] 엣지 케이스: 이중 클릭, 백버튼, 새로고침, 느린 네트워크

## 수동 테스트 체크리스트(요약)

- [ ] 정상 결제 → 예약 상태 `RESERVATION_PENDING`, 북킹 상세 이동
- [ ] 타임아웃 만료 후 결제 시도 → 차단 및 홈 리다이렉트
- [ ] 결제 실패/취소 → 사용자 메시지/재시도 동작
- [ ] 40101 → 자동 재발급 후 재시도, 40102 → 로그아웃 리다이렉트
- [ ] 403 → 접근 거부 페이지 이동

## 참고

- 예약 타이머/검증은 `reservation`, `payment` 페이지에서 KST 기준으로 구현되어 있음
- API 유틸: `src/lib/api.ts` (재발급/403/에러 공통 처리)
